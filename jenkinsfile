pipeline {
  agent any

  environment {
    // Docker
    DOCKER_IMAGE = "deepakjaiswal09/jenkins-demo"
    DOCKER_CREDS = "docker-hub-creds"     // Jenkins credential ID (Username+Password for Docker Hub)

    // EC2 deploy
    EC2_USER = "ubuntu"
    EC2_HOST = "16.170.215.124"
    SSH_KEY  = "ec2-ssh-key"              // Jenkins credential ID for your PEM key (SSH Username with private key)

    // SNS notify
    AWS_REGION = "eu-north-1"
    SNS_ARN    = "arn:aws:sns:eu-north-1:448049822166:jenkins-notify"
  }

  stages {
    stage('Checkout') {
      steps {
        // Uses Jenkins' Git plugin; no bat/sh needed
        git 'https://github.com/deepakjaiswal09/jenkins-ci-cd-demo.git'
      }
    }

    stage('Build Docker Image') {
      steps {
        bat """
        docker build -t %DOCKER_IMAGE%:%BUILD_NUMBER% .
        """
      }
    }

    stage('Test') {
      steps {
        bat """
        npm test
        """
      }
    }

    stage('Push to DockerHub') {
      steps {
        withCredentials([usernamePassword(credentialsId: "${DOCKER_CREDS}",
                                          usernameVariable: 'DOCKER_USER',
                                          passwordVariable: 'DOCKER_PASS')]) {
          bat """
          echo %DOCKER_PASS% | docker login -u %DOCKER_USER% --password-stdin
          docker push %DOCKER_IMAGE%:%BUILD_NUMBER%
          """
        }
      }
    }

    stage('Deploy to AWS EC2') {
      steps {
        // Requires OpenSSH client available on the Windows agent
        sshagent (credentials: ["${SSH_KEY}"]) {
          bat """
          ssh -o StrictHostKeyChecking=no %EC2_USER%@%EC2_HOST% "docker rm -f jenkins-demo || true && docker pull %DOCKER_IMAGE%:%BUILD_NUMBER% && docker run -d -p 3000:3000 --name jenkins-demo %DOCKER_IMAGE%:%BUILD_NUMBER%"
          """
        }
      }
    }

    stage('Notify Success') {
      steps {
        // Uses AWS CLI v2 installed on the Windows agent
        withCredentials([
          string(credentialsId: 'aws-access-key-id',     variable: 'AWS_ACCESS_KEY_ID'),
          string(credentialsId: 'aws-secret-access-key', variable: 'AWS_SECRET_ACCESS_KEY')
        ]) {
          bat """
          aws configure set region %AWS_REGION%
          aws sns publish --topic-arn %SNS_ARN% --message "Build #%BUILD_NUMBER% succeeded: Image pushed & deployed to EC2 (%EC2_HOST%)." --subject "Jenkins Success: Build #%BUILD_NUMBER%"
          """
        }
      }
    }
  }

  post {
    failure {
      withCredentials([
        string(credentialsId: 'aws-access-key-id',     variable: 'AWS_ACCESS_KEY_ID'),
        string(credentialsId: 'aws-secret-access-key', variable: 'AWS_SECRET_ACCESS_KEY')
      ]) {
        bat """
        aws configure set region %AWS_REGION%
        aws sns publish --topic-arn %SNS_ARN% --message "Build #%BUILD_NUMBER% failed. Check Jenkins logs." --subject "Jenkins FAILED: Build #%BUILD_NUMBER%"
        """
      }
    }
  }
}
